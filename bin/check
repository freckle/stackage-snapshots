#!/usr/bin/env bash
#
# Perform a simplified (and dry-run) build of the representative package used on
# CI. Can be used as as spot-check or to get updated package SHAs.
#
##
set -euo pipefail

if (($# != 0)); then
  snapshots=("$@")
else
  mapfile -t snapshots < <(find ./lts/ -type f | sort --reverse --version-sort | head -n 1)
fi

for snapshot in "${snapshots[@]}"; do
  (
    cd test
    m4 -D "RESOLVER=../$snapshot" <stack.yaml.in >stack.yaml
    echo "Dry-run building $snapshot..."
    stack build --dry-run
    git clean -fd .
  )

  if command -v stack-lint-extra-deps &>/dev/null; then
    echo "Linting $snapshot..."
    stack lint-extra-deps \
      --path "$snapshot" \
      --exclude '*/amazonka' \
      --exclude 'weeder' \
      --exclude 'algebraic-graphs'
  fi
done
